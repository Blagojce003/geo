<head>
  <link rel="stylesheet" href="client/main.css">
  <script src="client/rainbow.js"></script>
  <script src="client/viewport.js"></script>
  <script src="client/movieroll.js"></script>
  <script src="client/source-view.js"></script>
</head>
<body>
  <div id="rootElement">
    <div class="top-panel">
      <div class="debug-panel">
        <input type="file" id="debugFile" title="&nbsp;" style="display:none"/>
        <button id="selectFile">Select debug file</button>
      </div>
      <div class="message-panel" id="messagePanel"></div>
      <div class="vertical-bar"></div>
      <div class="frame-panel">
        <button id="jumpPrev">&#8676;</button>
        <button class='step' id="stepPrev">&#8672;</button>
        <span class="tmp"></span>
        <button class='step' id="stepNext">&#8674;</button>
        <button id="jumpNext">&#8677;</button>
      </div>
      <div class="vertical-bar"></div>
      <div class="coords-panel" id="coordsPanel"></div>
      <div class="vertical-bar"></div>
      <div class="options-panel">
        <input type="checkbox" id="gridCheckbox" checked>Show grid</input>
      </div>
    </div>
    <canvas id="canvas">
    </canvas>
    <div class="source-panel">
      <pre id="sourceElement"><code id="sourceBox"></code></pre>
  </div>
  </div>
</body>

<script type="text/javascript">
  var debugFile = document.getElementById('debugFile');
  var selectFileButton = document.getElementById('selectFile');
  var jumpPrevButton = document.getElementById('jumpPrev');
  var jumpNextButton = document.getElementById('jumpNext');
  var stepPrevButton = document.getElementById('stepPrev');
  var stepNextButton = document.getElementById('stepNext');
  var coordsPanel = document.getElementById('coordsPanel');
  var gridCheckbox = document.getElementById('gridCheckbox');
  var messagePanel = document.getElementById('messagePanel');
  var rootElement = document.getElementById('rootElement');
  var sourceElement = document.getElementById('sourceElement');
  var sourceBox = document.getElementById('sourceBox');
  var canvas = document.getElementById('canvas');
  var viewport = new Viewport(canvas);
  var W = 0;
  var H = 0;
  var dark = false;

  var sourceView = new SourceView(sourceBox);
  var jsonData = null;
  var movieRoll = null;
  var drawStack = []; 
  function restart() {
      sourceView.setSource([]);
      messagePanel.innerHTML = '';
      movieRoll = null;
      drawStack = [];
      dark = false;
      resize();
      draw();
      var jsonStr = localStorage.getItem('current_json_data');
      if (jsonStr == null) {
          return;
      }
      try {
          jsonData = JSON.parse(jsonStr);
      } catch (err) {
          jsonData = null;
          console.error(err);
          localStorage.removeItem('current_json_data');
          messagePanel.innerHTML = '<span class="error">Error processing debug file.</span>';
          return;
      }
      if (jsonData.root) {
          if (jsonData.source_code) {
              sourceView.setSource(jsonData.source_code);
          }
          dark = jsonData.theme == 'dark';
          movieRoll = new MovieRoll(jsonData.root);
      }
      if (dark) {
          rootElement.classList.add('dark');
      } else {
          rootElement.classList.remove('dark');
      }
      resize();
      if (movieRoll != null) {
          messagePanel.innerHTML = '<span class="ok">Success</span>';
          nextFrame();
      } else {
          draw();
          messagePanel.innerHTML = '<span class="error">Error</span>';
      }
  }

  function updateControls() {
      if (movieRoll == null) {
          jumpPrevButton.disabled = true;
          jumpNextButton.disabled = true;
          stepPrevButton.disabled = true;
          stepNextButton.disabled = true;
      } else {
          var frame = movieRoll.currentFrame;
          jumpPrevButton.disabled = frame.prev == null;
          jumpNextButton.disabled = frame.next == null;
          stepPrevButton.disabled = frame.prev == null;
          stepNextButton.disabled = frame.next == null;
      }
  }
  
  function handleDebugSelect(evt) {
      var files = evt.target.files;
      if (files.length != 1) return;
      var reader = new FileReader();
      reader.onload = function(e) {
          localStorage.setItem('current_json_data', e.target.result);
          debugFile.value = null;
          restart();
      };
      reader.readAsText(files[0]);
  }
  
  function resize() {
      W = window.innerWidth;
      H = window.innerHeight - 37;
      canvas.width = W;
      canvas.height = H;
      var targetWidth = sourceView.lines.length == 0 ? 180 : 700;
      sourceElement.style.height = H + 'px';
      sourceElement.style.width = Math.min(targetWidth, W / 2) + 'px';
  }


  function canvasX(x) { return (x - viewport.x0) / viewport.scale; }
  function canvasY(y) { return H - (y - viewport.y0) / viewport.scale; }
  function planeX(x) { return viewport.x0 + x * viewport.scale; }
  function planeY(y) { return viewport.y0 + (H - y) * viewport.scale; }
  function rgbToString(rgb) {
      return 'rgb(' + rgb[0] + ', ' + rgb[1] + ', ' + rgb[2] + ')';
  }

  function drawGrid(ctx) {
      var draw = gridCheckbox.checked;
      if (draw == false) return;
      var x1 = planeX(0);
      var y1 = planeY(H);
      var x2 = planeX(W);
      var y2 = planeY(0);
      var p0 = 1;
      while (p0 / viewport.scale < 15) p0 *= 2;
      var pAdjustment = p0 / viewport.scale / 15;
      ctx.lineWidth = 1;
      for (var p = p0; p <= p0 * 16; p *= 2) {
          var spacing = p / viewport.scale;
          var pp = p / p0;
          var grey = Math.max(175, 255 - (p / viewport.scale / 15) * 5);
          if (dark) {
              grey = 255 - grey + 50;
          }
          ctx.strokeStyle = rgbToString([grey, grey, grey]);
          for (var i = Math.floor(x1 / p); i * p <= x2; i += 1) {
              var t = (i & -i);
              if (pp < 16 && t >= 2) continue;
              var x = canvasX(i * p);
              ctx.beginPath();
              ctx.moveTo(x, 0);
              ctx.lineTo(x, H);
              ctx.stroke();
          } 
          for (var i = Math.floor(y1 / p); i * p <= y2; i += 1) {
              var t = (i & -i);
              if (pp < 16 && t >= 2) continue;
              var y = canvasY(i * p);
              ctx.beginPath();
              ctx.moveTo(0, y);
              ctx.lineTo(W, y);
              ctx.stroke();
          }
      }
  }
  
  function draw() {
      updateControls();
      var ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, W, H);
      drawGrid(ctx, W, H);
      drawStack.forEach(function(item) {
          ctx.strokeStyle = dark ? 'white' : 'black';
          ctx.fillStyle = dark ? 'white' : 'black';
          var lineWidth = 1;
          var hasFill = false;
          var attr = 'attr' in item ? item.attr : '';
          attr.split(' ').forEach(function(s) {
              if (s == 'bold') {
                  lineWidth += 2;
              } else {
                  tokens = s.split(':');
                  if (tokens.length >= 1) {
                      if (tokens[0] == 'rainbow') {
                          ctx.strokeStyle = rgbToString(rainbow(item.progress)); 
                      } else if (tokens[0] == 'lightrainbow') {
                          ctx.strokeStyle = rgbToString(lightRainbow(item.progress));
                      } else {
                          ctx.strokeStyle = tokens[0];
                      }
                  }
                  if (tokens.length >= 2) {
                      if (tokens[1] == 'rainbow') {
                          ctx.fillStyle = rgbToString(rainbow(item.progress)); 
                      } else if (tokens[1] == 'lightrainbow') {
                          ctx.fillStyle = rgbToString(lightRainbow(item.progress));
                      } else {
                          ctx.fillStyle = tokens[1];
                      }
                      hasFill = true;
                  }
              }
          });
          ctx.lineWidth = lineWidth;
          if (item.type == 'point') {
              if (!hasFill) {
                  ctx.fillStyle = ctx.strokeStyle;
              }
              ctx.beginPath();
              ctx.arc(canvasX(item.x), canvasY(item.y), 3, 0, 2 * Math.PI, true);
              ctx.fill();
              ctx.stroke();
          } else if (item.type == 'circ') {
              ctx.beginPath();
              ctx.arc(canvasX(item.x), canvasY(item.y), item.r / viewport.scale,
                      0, 2 * Math.PI, true);
              if (hasFill) {
                  ctx.fill();
              }
              ctx.stroke();

          } else if (item.type == 'segment') {
              ctx.beginPath();
              ctx.moveTo(canvasX(item.x1), canvasY(item.y1));
              ctx.lineTo(canvasX(item.x2), canvasY(item.y2));
              ctx.stroke();
          } else if (item.type == 'polyline' || item.type == 'polygon' ||
                     item.type == 'triangle' || item.type == 'rect') {
              ctx.beginPath();
              var firstx = null;
              var firxty = null;
              item.points.forEach(function(point, i) {
                  var x = canvasX(point[0]);
                  var y = canvasY(point[1]);
                  if (i == 0) {
                      firstx = x;
                      firsty = y;
                      ctx.moveTo(x, y);
                  } else {
                      ctx.lineTo(x, y);
                  }
              });
              if (item.type != 'polyline') {
                  ctx.lineTo(firstx, firsty);
                  if (hasFill) {
                      ctx.fill();
                  }
              }
              ctx.stroke();
          } else if (item.type == 'line') {
              var x1 = planeX(0);
              var x2 = planeX(W);
              var y1 = planeY(H);
              var y2 = planeY(0);
              var noPoints = true;
              var xMin = null;
              var yMin = null;
              var xMax = null;
              var yMax = null;
              
              function considerPoint(x, y) {
                  if (x < x1 - 1 || x > x2 + 1) return;
                  if (y < y1 - 1 || y > y2 + 1) return;
                  if (noPoints || (x < xMin || x == xMin && (y < yMin))) {
                      xMin = x;
                      yMin = y;
                  }
                  if (noPoints || (x > xMax || x == xMax && (y > yMax))) {
                      xMax = x;
                      yMax = y;
                  }
                  noPoints = false;
              }

              var x0 = item.x1;
              var y0 = item.y1;
              var dx = item.x2 - item.x1;
              var dy = item.y2 - item.y1;
              [x1, x2].forEach(function(x) {
                  if (dx != 0) {
                      considerPoint(x, y0 + (x - x0) * dy / dx);
                  }
              });
              [y1, y2].forEach(function(y) {
                  if (dy != 0) {
                      considerPoint(x0 + (y - y0) * dx / dy, y);
                  }
              });
              
              if (!noPoints) {
                  ctx.beginPath();
                  ctx.moveTo(canvasX(xMin), canvasY(yMin));
                  ctx.lineTo(canvasX(xMax), canvasY(yMax));
                  ctx.stroke();
              }
          }
      });
  }

  function nextFrame(step) {
      if (movieRoll == null) return;
      var anyAction = false;
      for (;;) {
          var transition = movieRoll.currentFrame.next;
          if (transition == null) break;
          transition.actions.forEach(function(action) {
              if (action.type == 'add') {
                  anyAction = true;
                  drawStack.push(action.data);
              } else if (action.type == 'remove') {
                  drawStack.pop();
              } else if (action.type == 'execute') {
                  sourceView.highlight(action.data.line, action.data.type, 'added');
                  sourceView.updateTooltip(action.data.line, action.data.type,
                                           action.data.newLabel, true);
              }
          });
          movieRoll.currentFrame = transition.next;
          if (step || movieRoll.currentFrame.breakpoint && anyAction) break;
      }
      draw();
  }

  function prevFrame(step) {
      if (movieRoll == null) return;
      var anyAction = false;
      for (;;) {
          var transition = movieRoll.currentFrame.prev;
          if (transition == null) break;
          transition.actions.forEach(function(action) {
              //console.log('Action ', action.type, action.data);
              if (action.type == 'remove') {
                  anyAction = true;
                  drawStack.push(action.data);
              } else if (action.type == 'add') {
                  drawStack.pop();
              } else if (action.type == 'execute') {
                  sourceView.highlight(action.data.line, action.data.type, 'removed');
                  sourceView.updateTooltip(action.data.line, action.data.type,
                                           action.data.oldLabel, true);
              }
          });
          movieRoll.currentFrame = transition.prev;
          if (step || movieRoll.currentFrame.breakpoint && anyAction) break;
      }
      draw();
  }

  function keypress(e) {
      if (e.key == 'ArrowRight') {
          nextFrame(false);
      } else if (e.key == 'ArrowLeft') {
          prevFrame(false);
      } else if (e.key == ',') {
          prevFrame(true);
      } else if (e.key == '.') {
          nextFrame(true);
      }
  }

  function updateCoords() {
      if (viewport.coordsX == null || viewport.coordsY == null) {
          coordsPanel.innerHTML = '';
      } else {
          var digits = Math.max(0,
                                -Math.floor(Math.log10(viewport.scale)));
          coordsPanel.innerHTML =
              (viewport.coordsX.toFixed(digits) + ', ' +
               viewport.coordsY.toFixed(digits));
      }
  }

  restart();
  updateCoords();
  viewport.addDrawEventListener(draw);
  viewport.addCoordsEventListener(updateCoords);
  window.addEventListener('resize', function() { resize(); draw(); }, false);
  document.addEventListener('keydown', keypress, false);
  debugFile.addEventListener('change', handleDebugSelect, false);
  gridCheckbox.addEventListener('change', function() { draw(); }, false);
  selectFileButton.addEventListener('click', function() { debugFile.click(); }, false);
  jumpPrevButton.addEventListener('click', function() { prevFrame(false); }, false);
  stepPrevButton.addEventListener('click', function() { prevFrame(true); }, false);
  stepNextButton.addEventListener('click', function() { nextFrame(true); }, false);
  jumpNextButton.addEventListener('click', function() { nextFrame(false); }, false);
  
  // TMP code.

      /*
      polys.forEach(function(poly, i) {
          rgb = poly[3]
          ctx.fillStyle = 'rgb(' + rgb[0] + ', ' + rgb[1] + ', ' + rgb[2] + ')';
          ctx.strokeStyle = 'rgb(' + 0.7*rgb[0] + ', ' + 0.7*rgb[1] + ', ' + 0.7*rgb[2] + ')';
          ctx.beginPath();
          var x1 = (poly[0][0] - viewport.x0) / viewport.scale;
          var x2 = (poly[1][0] - viewport.x0) / viewport.scale;
          var x3 = (poly[2][0] - viewport.x0) / viewport.scale;
          var y1 = H - (poly[0][1] - viewport.y0) / viewport.scale;
          var y2 = H - (poly[1][1] - viewport.y0) / viewport.scale;
          var y3 = H - (poly[2][1] - viewport.y0) / viewport.scale;
          
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.lineTo(x3, y3);
          ctx.lineTo(x1, y1);
          ctx.fill();
          ctx.stroke();
          });*/
  /*  
  var polys = [];
  for (var iter = 0; iter < 3; ++iter) {
      var arg = Math.random() * 6.28;
      var R = (iter + 1) * 17;
      var n = (iter + 1) * 30;
      for (var i = 0; i < n; ++i) {
          var x0 = 60 + Math.sin(i / n * 5.8 + arg) * R;
          var y0 = 50 + Math.cos(i / n * 5.8 + arg) * R;
          var x1 = x0 + Math.random() * 8 - 4;
          var y1 = y0 + Math.random() * 8 - 4;
          var x2 = x0 + Math.random() * 16 - 8;
          var y2 = y0 + Math.random() * 16 - 8;
          var x3 = x0 + Math.random() * 16 - 8;
          var y3 = y0 + Math.random() * 16 - 8;
          var area = Math.abs((x2 - x1) * (y3 - y1) - (x3 - x1) * (y2 - y1));
          if (area < 100) {
              --i; continue;
          }
          var color = rainbowProgress(i, n);
          polys.push([[x1, y1], [x2, y2], [x3, y3], color]);
      }
  }*/

      
 
  
</script>
